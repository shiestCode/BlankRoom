### 事务

#### 基本概念

1.原子性：事务是最小的执行单元，要么执行成功，要么回滚

2.持久性：事务只要提交了就会生效，即使是数据库出现问题

3.隔离性：并发事务之间是相互独立的，彼此是不受影响的

4.一致性：事务提交前后数据是一致的

-----------------

#### Spring事务管理

##### PlatformTransactionManager Spring的事务管理器

> ​	Spring自己是不管理事务的，而是开放接口，将事务管理交给Hibernate，JTA，DataSource等持久化框架

````java
public interface PlatformTransactionManager {

	TransactionStatus getTransaction(TransactionDefinition definition) throws TransactionException;

	void commit(TransactionStatus status) throws TransactionException;

	void rollback(TransactionStatus status) throws TransactionException;

}
````

​	Spring获取持久化框架的TransactionManager，这个类里定义了所使用的持久化框架的规则，Spring会根据规定进行事务的提交或事务的回滚。

| 事务                                                         | 说明               |
| ------------------------------------------------------------ | ------------------ |
| org.springframework.jdbc.datasource.DataSourceTransactionManager | Spring JDBC/iBaits |
| org.springframework.orm.hibernate3.HibernateTransactionManager | Hibernate          |
| org.springframework.orm.jpa.JpaTransactionManager            | JPA                |
| org.springframework.transaction.jta.JtaTransactionManager    | JTA                |

##### TransactionDefinition事务定义信息(隔离级别，传播行为，超时，只读，回滚规则)

> 表示事务的基本属性，描述事务策略如何应用到方法上。

````java
public interface TransactionDefinition {
    //获取事务的传播行为
    int getPropagationBehavior();
    //获取事务的隔离级别
    int getIsolationLevel();
    //获取事务的名字
    String getName;
    //获取事务的超时时间
    int getTimeout;
    //是否为可读事务
    boolean isReadOnly;
}
````

1.事务的传播行为

> 解决业务层代码之间相互调用事务的问题：我在一个事务中调用了另一个事务，我们的事务属性可能是不同的，为了解决这这种问题，我们规定了事务的传播行为

​	

| 事务传播行为              | 说明                                                         |
| ------------------------- | ------------------------------------------------------------ |
| PROPAGATION_REQUIRED      | 支持当前事务，假设当前没有事务。就新建一个事务               |
| PROPAGATION_SUPPORTS      | 支持当前事务，假设当前没有事务，就以非事务方式运行           |
| PROPAGATION_MANDATORY     | 支持当前事务，假设当前没有事务，就抛出异常                   |
| PROPAGATION_REQUIRES_NEW  | 新建事务，假设当前存在事务。把当前事务挂起                   |
| PROPAGATION_NOT_SUPPORTED | 以非事务方式运行操作。假设当前存在事务，就把当前事务挂起     |
| PROPAGATION_NEVER         | 以非事务方式运行，假设当前存在事务，则抛出异常               |
| PROPAGATION_NESTED        | 如果当前存在事务，则在嵌套事务内执行。如果当前没有事务，则执行与PROPAGATION_REQUIRED类似的操作。 |



##### TransactionStatus事务运行状态